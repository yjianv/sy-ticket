<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.syticket.mapper.TicketMapper">

    <!-- 工单结果映射（包含关联对象） -->
    <resultMap id="TicketWithRelationsResultMap" type="com.syticket.entity.Ticket">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="ticketNo" column="ticket_no"/>
        <result property="priority" column="priority"/>
        <result property="status" column="status"/>
        <result property="type" column="type"/>
        <result property="workspaceId" column="workspace_id"/>
        <result property="creatorId" column="creator_id"/>
        <result property="assigneeId" column="assignee_id"/>
        <result property="resolverId" column="resolver_id"/>
        <result property="moduleId" column="module_id"/>
        <result property="estimatedHours" column="estimated_hours"/>
        <result property="actualHours" column="actual_hours"/>
        <result property="dueDate" column="due_date"/>
        <result property="resolvedAt" column="resolved_at"/>
        <result property="closedAt" column="closed_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        
        <!-- 关联工作空间 -->
        <association property="workspace" javaType="com.syticket.entity.Workspace">
            <id property="id" column="ws_id"/>
            <result property="name" column="ws_name"/>
            <result property="code" column="ws_code"/>
            <result property="color" column="ws_color"/>
        </association>
        
        <!-- 关联创建人 -->
        <association property="creator" javaType="com.syticket.entity.User">
            <id property="id" column="creator_id"/>
            <result property="username" column="creator_username"/>
            <result property="realName" column="creator_real_name"/>
            <result property="avatar" column="creator_avatar"/>
        </association>
        
        <!-- 关联指派人 -->
        <association property="assignee" javaType="com.syticket.entity.User">
            <id property="id" column="assignee_id"/>
            <result property="username" column="assignee_username"/>
            <result property="realName" column="assignee_real_name"/>
            <result property="avatar" column="assignee_avatar"/>
        </association>
        
        <!-- 关联解决人 -->
        <association property="resolver" javaType="com.syticket.entity.User">
            <id property="id" column="resolver_id"/>
            <result property="username" column="resolver_username"/>
            <result property="realName" column="resolver_real_name"/>
            <result property="avatar" column="resolver_avatar"/>
        </association>
        
        <!-- 关联模块 -->
        <association property="module" javaType="com.syticket.entity.Module">
            <id property="id" column="module_id"/>
            <result property="name" column="module_name"/>
            <result property="description" column="module_description"/>
            <result property="ownerId" column="module_owner_id"/>
            <result property="enabled" column="module_enabled"/>
            <result property="sortOrder" column="module_sort_order"/>
        </association>
    </resultMap>

    <!-- 基础字段SQL片段 -->
    <sql id="ticketBaseColumns">
        t.id, t.title, t.content, t.ticket_no, t.priority, t.status, t.type,
        t.workspace_id, t.creator_id, t.assignee_id, t.resolver_id, t.module_id,
        t.estimated_hours, t.actual_hours, t.due_date, t.resolved_at, t.closed_at,
        t.created_at, t.updated_at
    </sql>

    <!-- 关联字段SQL片段 -->
    <sql id="ticketWithRelationsColumns">
        <include refid="ticketBaseColumns"/>,
        ws.id as ws_id, ws.name as ws_name, ws.code as ws_code, ws.color as ws_color,
        creator.username as creator_username, creator.real_name as creator_real_name, creator.avatar as creator_avatar,
        assignee.username as assignee_username, assignee.real_name as assignee_real_name, assignee.avatar as assignee_avatar,
        resolver.username as resolver_username, resolver.real_name as resolver_real_name, resolver.avatar as resolver_avatar,
        m.name as module_name, m.description as module_description, m.owner_id as module_owner_id, 
        m.enabled as module_enabled, m.sort_order as module_sort_order
    </sql>

    <!-- 关联表JOIN片段 -->
    <sql id="ticketJoins">
        LEFT JOIN workspaces ws ON t.workspace_id = ws.id
        LEFT JOIN users creator ON t.creator_id = creator.id
        LEFT JOIN users assignee ON t.assignee_id = assignee.id
        LEFT JOIN users resolver ON t.resolver_id = resolver.id
        LEFT JOIN modules m ON t.module_id = m.id
    </sql>

    <!-- 根据ID查找工单（包含关联信息） -->
    <select id="findByIdWithRelations" resultMap="TicketWithRelationsResultMap">
        SELECT <include refid="ticketWithRelationsColumns"/>
        FROM tickets t
        <include refid="ticketJoins"/>
        WHERE t.id = #{id}
    </select>

    <!-- 条件查询工单列表 -->
    <select id="findWithConditions" resultMap="TicketWithRelationsResultMap">
        SELECT <include refid="ticketWithRelationsColumns"/>
        FROM tickets t
        <include refid="ticketJoins"/>
        <where>
            <if test="params.workspaceId != null">
                AND t.workspace_id = #{params.workspaceId}
            </if>
            <if test="params.status != null">
                AND t.status = #{params.status}
            </if>
            <if test="params.priority != null">
                AND t.priority = #{params.priority}
            </if>
            <if test="params.type != null">
                AND t.type = #{params.type}
            </if>
            <if test="params.creatorId != null">
                AND t.creator_id = #{params.creatorId}
            </if>
            <if test="params.assigneeId != null">
                AND t.assignee_id = #{params.assigneeId}
            </if>
            <if test="params.keyword != null and params.keyword != ''">
                AND (t.title LIKE CONCAT('%', #{params.keyword}, '%') 
                     OR t.ticket_no LIKE CONCAT('%', #{params.keyword}, '%'))
            </if>
        </where>
        ORDER BY t.created_at DESC
    </select>

    <!-- 查询用户相关的工单 -->
    <select id="findUserRelatedTickets" resultMap="TicketWithRelationsResultMap">
        SELECT <include refid="ticketWithRelationsColumns"/>
        FROM tickets t
        <include refid="ticketJoins"/>
        WHERE (t.creator_id = #{userId} OR t.assignee_id = #{userId})
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
        ORDER BY t.created_at DESC
    </select>

    <!-- 查询用户相关的工单（限制数量） -->
    <select id="findUserRelatedTicketsWithLimit" resultMap="TicketWithRelationsResultMap">
        SELECT <include refid="ticketWithRelationsColumns"/>
        FROM tickets t
        <include refid="ticketJoins"/>
        WHERE (t.creator_id = #{userId} OR t.assignee_id = #{userId})
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
        ORDER BY t.created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 统计工单数量 -->
    <select id="countWithConditions" resultType="int">
        SELECT COUNT(*)
        FROM tickets t
        <where>
            <if test="params.workspaceId != null">
                AND t.workspace_id = #{params.workspaceId}
            </if>
            <if test="params.status != null">
                AND t.status = #{params.status}
            </if>
            <if test="params.priority != null">
                AND t.priority = #{params.priority}
            </if>
            <if test="params.type != null">
                AND t.type = #{params.type}
            </if>
            <if test="params.creatorId != null">
                AND t.creator_id = #{params.creatorId}
            </if>
            <if test="params.assigneeId != null">
                AND t.assignee_id = #{params.assigneeId}
            </if>
            <if test="params.keyword != null and params.keyword != ''">
                AND (t.title LIKE CONCAT('%', #{params.keyword}, '%') 
                     OR t.ticket_no LIKE CONCAT('%', #{params.keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 生成工单编号 -->
    <select id="generateTicketNo" resultType="string">
        SELECT CONCAT(#{workspaceCode}, '-', DATE_FORMAT(NOW(), '%Y%m%d'), '-', 
                     LPAD(IFNULL(MAX(CAST(SUBSTRING(ticket_no, -4) AS UNSIGNED)), 0) + 1, 4, '0'))
        FROM tickets 
        WHERE ticket_no LIKE CONCAT(#{workspaceCode}, '-', DATE_FORMAT(NOW(), '%Y%m%d'), '-%')
    </select>

    <!-- 插入工单 -->
    <insert id="insert" parameterType="com.syticket.entity.Ticket" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tickets (
            title, content, ticket_no, priority, status, type, workspace_id, creator_id,
            assignee_id, resolver_id, module_id, estimated_hours, actual_hours, due_date
        ) VALUES (
            #{title}, #{content}, #{ticketNo}, #{priority}, #{status}, #{type}, #{workspaceId}, #{creatorId},
            #{assigneeId}, #{resolverId}, #{moduleId}, #{estimatedHours}, #{actualHours}, #{dueDate}
        )
    </insert>

    <!-- 更新工单 -->
    <update id="update" parameterType="com.syticket.entity.Ticket">
        UPDATE tickets
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="content != null">content = #{content},</if>
            <if test="priority != null">priority = #{priority},</if>
            <if test="status != null">status = #{status},</if>
            <if test="type != null">type = #{type},</if>
            <if test="assigneeId != null">assignee_id = #{assigneeId},</if>
            <if test="resolverId != null">resolver_id = #{resolverId},</if>
            <if test="moduleId != null">module_id = #{moduleId},</if>
            <if test="estimatedHours != null">estimated_hours = #{estimatedHours},</if>
            <if test="actualHours != null">actual_hours = #{actualHours},</if>
            <if test="dueDate != null">due_date = #{dueDate},</if>
            <if test="resolvedAt != null">resolved_at = #{resolvedAt},</if>
            <if test="closedAt != null">closed_at = #{closedAt},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <!-- ===== 统计报表相关查询 ===== -->
    
    <!-- 获取工单总数 -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) 
        FROM tickets t
        <where>
            <if test="workspaceId != null">
                AND t.workspace_id = #{workspaceId}
            </if>
        </where>
    </select>
    
    <!-- 按状态统计工单数量 -->
    <select id="getCountByStatus" resultType="int">
        SELECT COUNT(*) 
        FROM tickets t
        <where>
            <if test="workspaceId != null">
                AND t.workspace_id = #{workspaceId}
            </if>
            <if test="status != null">
                AND t.status = #{status}
            </if>
        </where>
    </select>
    
    <!-- 获取今日新增工单数 -->
    <select id="getTodayNewCount" resultType="int">
        SELECT COUNT(*) 
        FROM tickets t
        WHERE DATE(t.created_at) = CURDATE()
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
    </select>
    
    <!-- 获取逾期工单数 -->
    <select id="getOverDueCount" resultType="int">
        SELECT COUNT(*) 
        FROM tickets t
        WHERE t.due_date &lt; NOW() 
        AND t.status NOT IN ('RESOLVED', 'CLOSED', 'CANCELLED')
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
    </select>
    
    <!-- 获取状态分布统计 -->
    <select id="getStatusDistribution" resultType="map">
        SELECT 
            t.status as name,
            COUNT(*) as value,
            CASE t.status
                WHEN 'OPEN' THEN '待处理'
                WHEN 'IN_PROGRESS' THEN '处理中'
                WHEN 'RESOLVED' THEN '已解决'
                WHEN 'CLOSED' THEN '已关闭'
                WHEN 'CANCELLED' THEN '已取消'
                ELSE t.status
            END as label
        FROM tickets t
        <where>
            <if test="workspaceId != null">
                AND t.workspace_id = #{workspaceId}
            </if>
        </where>
        GROUP BY t.status
        ORDER BY value DESC
    </select>
    
    <!-- 获取优先级分布统计 -->
    <select id="getPriorityDistribution" resultType="map">
        SELECT 
            t.priority as name,
            COUNT(*) as value,
            CASE t.priority
                WHEN 'LOW' THEN '低'
                WHEN 'MEDIUM' THEN '中'
                WHEN 'HIGH' THEN '高'
                WHEN 'URGENT' THEN '紧急'
                ELSE t.priority
            END as label
        FROM tickets t
        <where>
            <if test="workspaceId != null">
                AND t.workspace_id = #{workspaceId}
            </if>
        </where>
        GROUP BY t.priority
        ORDER BY FIELD(t.priority, 'URGENT', 'HIGH', 'MEDIUM', 'LOW')
    </select>
    
    <!-- 获取类型分布统计 -->
    <select id="getTypeDistribution" resultType="map">
        SELECT 
            t.type as name,
            COUNT(*) as value,
            CASE t.type
                WHEN 'BUG' THEN '缺陷'
                WHEN 'FEATURE' THEN '功能'
                WHEN 'IMPROVEMENT' THEN '改进'
                WHEN 'QUESTION' THEN '问题'
                WHEN 'OTHER' THEN '其他'
                ELSE t.type
            END as label
        FROM tickets t
        <where>
            <if test="workspaceId != null">
                AND t.workspace_id = #{workspaceId}
            </if>
        </where>
        GROUP BY t.type
        ORDER BY value DESC
    </select>
    
    <!-- 获取创建趋势数据 -->
    <select id="getCreationTrend" resultType="map">
        SELECT 
            DATE(t.created_at) as date,
            COUNT(*) as count
        FROM tickets t
        WHERE t.created_at >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
        GROUP BY DATE(t.created_at)
        ORDER BY DATE(t.created_at)
    </select>
    
    <!-- 获取用户工作量统计 -->
    <select id="getUserWorkload" resultType="map">
        SELECT 
            COALESCE(u.real_name, u.username) as userName,
            COUNT(CASE WHEN t.assignee_id = u.id THEN 1 END) as assignedCount,
            COUNT(CASE WHEN t.creator_id = u.id THEN 1 END) as createdCount,
            COUNT(CASE WHEN t.resolver_id = u.id THEN 1 END) as resolvedCount
        FROM users u
        LEFT JOIN tickets t ON (t.assignee_id = u.id OR t.creator_id = u.id OR t.resolver_id = u.id)
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
        WHERE u.enabled = 1
        GROUP BY u.id, u.username, u.real_name
        HAVING (assignedCount > 0 OR createdCount > 0 OR resolvedCount > 0)
        ORDER BY (assignedCount + createdCount + resolvedCount) DESC
        LIMIT 10
    </select>
    
    <!-- 获取平均处理时间 -->
    <select id="getAverageProcessTime" resultType="decimal">
        SELECT AVG(TIMESTAMPDIFF(HOUR, t.created_at, COALESCE(t.resolved_at, t.closed_at, NOW()))) 
        FROM tickets t
        WHERE t.status != 'OPEN'
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
    </select>
    
    <!-- 获取平均解决时间 -->
    <select id="getAverageResolveTime" resultType="decimal">
        SELECT AVG(TIMESTAMPDIFF(HOUR, t.created_at, t.resolved_at)) 
        FROM tickets t
        WHERE t.resolved_at IS NOT NULL
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
    </select>
    
    <!-- 获取最快解决时间 -->
    <select id="getMinResolveTime" resultType="decimal">
        SELECT MIN(TIMESTAMPDIFF(HOUR, t.created_at, t.resolved_at)) 
        FROM tickets t
        WHERE t.resolved_at IS NOT NULL
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
    </select>
    
    <!-- 获取最慢解决时间 -->
    <select id="getMaxResolveTime" resultType="decimal">
        SELECT MAX(TIMESTAMPDIFF(HOUR, t.created_at, t.resolved_at)) 
        FROM tickets t
        WHERE t.resolved_at IS NOT NULL
        <if test="workspaceId != null">
            AND t.workspace_id = #{workspaceId}
        </if>
    </select>
    
    <!-- 获取工作空间分布统计 -->
    <select id="getWorkspaceDistribution" resultType="map">
        SELECT 
            ws.name as workspaceName,
            COUNT(t.id) as ticketCount,
            ws.color as color
        FROM workspaces ws
        LEFT JOIN tickets t ON ws.id = t.workspace_id
        WHERE ws.enabled = 1
        GROUP BY ws.id, ws.name, ws.color
        ORDER BY ticketCount DESC
    </select>

</mapper>
