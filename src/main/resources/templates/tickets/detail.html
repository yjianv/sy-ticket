<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE" th:text="'工单详情 - ' + ${ticket.ticketNo}">工单详情</title>
</head>

<th:block layout:fragment="custom-head">
    <!-- 工单详情页面专用样式已移至 /css/pages.css -->
</th:block>

<body>
    <div layout:fragment="content">
        <!-- 页面标题和操作栏 -->
        <div class="page-header">
            <div class="page-header-content">
                <div class="page-header-left">
                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-1);">
                        <h1 class="page-header-title" th:text="${ticket.title}">工单标题</h1>
                        <span class="badge workspace-badge status-open"
                              th:classappend="'status-' + ${#strings.toLowerCase(ticket.status)}"
                              th:text="${ticket.status.description}">状态</span>
                        <span class="badge workspace-badge priority-medium"
                              th:classappend="'priority-' + ${#strings.toLowerCase(ticket.priority)}"
                              th:text="${ticket.priority.description}">优先级</span>
                    </div>
                    <p class="page-header-subtitle">
                        工单编号：<span style="font-family: var(--font-mono);" th:text="${ticket.ticketNo}">TICKET-001</span>
                    </p>
                </div>
                <div class="page-header-right">
                    <a th:href="@{/tickets/{id}/edit(id=${ticket.id})}" class="btn btn-success">
                        <i class="fas fa-edit"></i>编辑
                    </a>
                    <a href="/tickets" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>返回列表
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 主要内容区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：工单详情 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 工单描述 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">工单描述</h3>
                    </div>
                    <div class="card-body">
                        <div id="readonly-editor" class="readonly-editor"></div>
                    </div>
                </div>
                
                <!-- 附件区域 -->
                <div class="card" th:if="${attachments != null and !attachments.isEmpty()}">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-paperclip mr-2"></i>附件 
                            <span class="text-sm text-gray-500" th:text="'(' + ${attachments.size()} + '个)'"></span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div th:each="attachment : ${attachments}" class="attachment-item">
                                <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-all duration-200">
                                    <div class="flex-shrink-0 mr-3">
                                        <!-- 根据文件类型显示不同图标 -->
                                        <i class="fas fa-file-alt text-gray-500 text-lg"
                                           th:if="${attachment.mimeType.startsWith('text/')}"
                                           th:classappend="'text-blue-500'"></i>
                                        <i class="fas fa-file-image text-green-500 text-lg" 
                                           th:if="${attachment.mimeType.startsWith('image/')}"></i>
                                        <i class="fas fa-file-pdf text-red-500 text-lg" 
                                           th:if="${attachment.mimeType == 'application/pdf'}"></i>
                                        <i class="fas fa-file-word text-blue-600 text-lg" 
                                           th:if="${attachment.mimeType.contains('document') or attachment.mimeType.contains('word')}"></i>
                                        <i class="fas fa-file-excel text-green-600 text-lg" 
                                           th:if="${attachment.mimeType.contains('spreadsheet') or attachment.mimeType.contains('excel')}"></i>
                                        <i class="fas fa-file-archive text-yellow-600 text-lg" 
                                           th:if="${attachment.mimeType.contains('zip') or attachment.mimeType.contains('rar')}"></i>
                                        <i class="fas fa-file text-gray-500 text-lg" 
                                           th:if="${!attachment.mimeType.startsWith('image/') and !attachment.mimeType.startsWith('text/') and attachment.mimeType != 'application/pdf' and !attachment.mimeType.contains('document') and !attachment.mimeType.contains('word') and !attachment.mimeType.contains('spreadsheet') and !attachment.mimeType.contains('excel') and !attachment.mimeType.contains('zip') and !attachment.mimeType.contains('rar')}"></i>
                                    </div>
                                    <div class="flex-grow min-w-0">
                                        <div class="text-sm font-medium text-gray-900 truncate" th:text="${attachment.originalName}">文件名</div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span th:text="${#numbers.formatInteger(attachment.fileSize / 1024, 0)} + ' KB'">文件大小</span>
                                            <span class="mx-1">•</span>
                                            <span th:text="${#temporals.format(attachment.createdAt, 'yyyy-MM-dd HH:mm')}">上传时间</span>
                                        </div>
                                        <div class="text-xs text-gray-400 mt-1" th:if="${attachment.uploader != null}">
                                            <span>上传者：</span><span th:text="${attachment.uploader.realName}">上传者</span>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 ml-3">
                                        <a th:href="@{/api/files/{id}/download(id=${attachment.id})}" 
                                           target="_blank" 
                                           class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-100 transition-colors duration-200"
                                           title="下载附件">
                                            <i class="fas fa-download text-sm"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 评论区域 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">评论与讨论</h3>
                    </div>
                    <div class="card-body">
                        <!-- 添加评论 -->
                        <div style="margin-bottom: var(--space-6);">
                            <form id="comment-form">
                                <div class="form-group">
                                    <textarea id="comment-content" rows="3" class="form-textarea"
                                              placeholder="请输入您的评论..."></textarea>
                                </div>
                                <div style="display: flex; justify-content: flex-end;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-comment"></i>发表评论
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- 评论列表 -->
                        <div style="display: flex; flex-direction: column; gap: var(--space-4);" th:if="${comments != null and !comments.isEmpty()}">
                            <div th:each="comment : ${comments}" 
                                 class="card"
                                 th:classappend="${comment.type.name() == 'SYSTEM'} ? 'system-message' : ''"
                                 style="border: 1px solid var(--color-border); padding: var(--space-4);">
                                <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                    <div style="flex-shrink: 0;">
                                        <div class="avatar avatar-base"
                                             th:style="${comment.type.name() == 'SYSTEM'} ? 'background-color: var(--color-info-500);' : 'background-color: var(--color-gray-500);'"
                                             th:text="${comment.user?.realName?.substring(0,1) ?: 'S'}">U</div>
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2);">
                                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                                <span style="font-weight: var(--font-medium); color: var(--color-text-primary);" th:text="${comment.user?.realName ?: '系统'}">用户名</span>
                                                <span style="font-size: var(--text-xs); color: var(--color-text-secondary);" th:if="${comment.type.name() == 'SYSTEM'}">[系统消息]</span>
                                            </div>
                                            <span style="font-size: var(--text-sm); color: var(--color-text-secondary);" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">时间</span>
                                        </div>
                                        <div class="comment-content" th:text="${comment.content}">评论内容</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 无评论提示 -->
                        <div class="empty-state" th:if="${comments == null or comments.isEmpty()}">
                            <div class="empty-state-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3 class="empty-state-title">暂无评论</h3>
                            <p class="empty-state-description">成为第一个评论的人吧！</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：工单信息和操作 -->
            <div style="display: flex; flex-direction: column; gap: var(--space-6);">
                <!-- 工单信息 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">工单信息</h3>
                    </div>
                    <div class="card-body" style="display: flex; flex-direction: column; gap: var(--space-4);">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">类型</label>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full mt-1"
                                  th:classappend="'type-' + ${#strings.toLowerCase(ticket.type)}"
                                  th:text="${ticket.type.description}">类型</span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">创建人</label>
                            <div class="flex items-center mt-1" th:if="${ticket.creator != null}">
                                <div class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-medium mr-2"
                                     th:text="${ticket.creator.realName.substring(0,1)}">C</div>
                                <span th:text="${ticket.creator.realName}">创建人</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">指派人</label>
                            <div class="flex items-center mt-1" th:if="${ticket.assignee != null}">
                                <div class="w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-white text-xs font-medium mr-2"
                                     th:text="${ticket.assignee.realName.substring(0,1)}">A</div>
                                <span th:text="${ticket.assignee.realName}">指派人</span>
                            </div>
                            <span class="text-gray-500 text-sm mt-1" th:if="${ticket.assignee == null}">未指派</span>
                        </div>
                        
                        <div th:if="${ticket.resolver != null}">
                            <label class="block text-sm font-medium text-gray-700">解决人</label>
                            <div class="flex items-center mt-1">
                                <div class="w-6 h-6 rounded-full bg-purple-600 flex items-center justify-center text-white text-xs font-medium mr-2"
                                     th:text="${ticket.resolver.realName.substring(0,1)}">R</div>
                                <span th:text="${ticket.resolver.realName}">解决人</span>
                            </div>
                        </div>
                        
                        <div th:if="${ticket.estimatedHours != null}">
                            <label class="block text-sm font-medium text-gray-700">预估工时</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${ticket.estimatedHours} + ' 小时'">工时</span>
                        </div>
                        
                        <div th:if="${ticket.actualHours != null}">
                            <label class="block text-sm font-medium text-gray-700">实际工时</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${ticket.actualHours} + ' 小时'">工时</span>
                        </div>
                        
                        <div th:if="${ticket.dueDate != null}">
                            <label class="block text-sm font-medium text-gray-700">截止日期</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${#temporals.format(ticket.dueDate, 'yyyy-MM-dd HH:mm')}">截止时间</span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">创建时间</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${#temporals.format(ticket.createdAt, 'yyyy-MM-dd HH:mm')}">创建时间</span>
                        </div>
                        
                        <div th:if="${ticket.resolvedAt != null}">
                            <label class="block text-sm font-medium text-gray-700">解决时间</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${#temporals.format(ticket.resolvedAt, 'yyyy-MM-dd HH:mm')}">解决时间</span>
                        </div>
                    </div>
                </div>
                
                <!-- 快速操作 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">快速操作</h3>
                    </div>
                    <div class="p-6 space-y-3">
                        <!-- 指派工单 -->
                        <div>
                            <label for="assign-user" class="block text-sm font-medium text-gray-700 mb-2">指派给</label>
                            <div class="flex space-x-2">
                                <select id="assign-user" disabled class="flex-grow px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed">
                                    <option value="">选择用户</option>
                                    <option th:each="user : ${users}" 
                                            th:value="${user.id}" 
                                            th:text="${user.realName}"
                                            th:selected="${ticket.assignee != null and user.id == ticket.assignee.id}">
                                        用户
                                    </option>
                                </select>
                                <button type="button" disabled class="bg-gray-400 text-white px-3 py-2 rounded-lg cursor-not-allowed" title="指派功能已禁用">
                                    指派
                                </button>
                            </div>
                        </div>
                        
                        <!-- 状态操作 -->
                        <div class="space-y-2">
                            <button type="button" onclick="changeStatus('IN_PROGRESS')" 
                                    class="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'OPEN'}">
                                <i class="fas fa-play mr-2"></i>开始处理
                            </button>
                            
                            <button type="button" onclick="changeStatus('RESOLVED')" 
                                    class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'IN_PROGRESS'}">
                                <i class="fas fa-check mr-2"></i>标记解决
                            </button>
                            
                            <button type="button" onclick="changeStatus('CLOSED')" 
                                    class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'RESOLVED'}">
                                <i class="fas fa-archive mr-2"></i>关闭工单
                            </button>
                            
                            <button type="button" onclick="changeStatus('OPEN')" 
                                    class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'CLOSED' or ticket.status.name() == 'RESOLVED'}">
                                <i class="fas fa-redo mr-2"></i>重新打开
                            </button>
                        </div>
                        
                        <!-- 移交工单 -->
                        <div>
                            <button type="button" onclick="showTransferModal()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-150 ease-in-out">
                                <i class="fas fa-exchange-alt mr-2"></i>移交工单
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 流转记录 -->
                <div class="bg-white shadow rounded-lg" th:if="${flows != null and !flows.isEmpty()}">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">流转记录</h3>
                    </div>
                    <div class="p-6">
                        <div class="flow-timeline">
                            <div th:each="flow : ${flows}" class="flow-item">
                                <div class="text-sm">
                                    <div class="font-medium text-gray-900" th:text="${flow.action}">操作</div>
                                    <div class="text-gray-600 mt-1">
                                        <span th:if="${flow.fromUser != null}" th:text="${flow.fromUser.realName}">操作人</span>
                                        <span th:if="${flow.toUser != null}"> → <span th:text="${flow.toUser.realName}">接收人</span></span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1" th:text="${#temporals.format(flow.createdAt, 'yyyy-MM-dd HH:mm')}">时间</div>
                                    <div class="text-sm text-gray-700 mt-1" th:if="${flow.reason != null and !flow.reason.isEmpty()}" th:text="${flow.reason}">原因</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 移交工单模态框 -->
        <div id="transfer-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">移交工单</h3>
                    <div class="mb-4">
                        <label for="transfer-user" class="block text-sm font-medium text-gray-700 mb-2">移交给</label>
                        <select id="transfer-user" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">选择用户</option>
                            <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.realName}">用户</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="transfer-reason" class="block text-sm font-medium text-gray-700 mb-2">移交原因</label>
                        <textarea id="transfer-reason" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="请说明移交原因..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideTransferModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            取消
                        </button>
                        <button type="button" onclick="submitTransfer()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            确认移交
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<th:block layout:fragment="custom-script">
    <!-- Editor.js (只读模式) -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest/dist/editor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest/dist/bundle.js"></script>
    
    <script th:inline="javascript">
        let ticketId = /*[[${ticket.id}]]*/ null;
        
        $(document).ready(function() {
            // 初始化只读编辑器
            initReadonlyEditor();
            
            // 评论表单提交
            $('#comment-form').on('submit', function(e) {
                e.preventDefault();
                submitComment();
            });
        });
        
        // 初始化只读编辑器
        function initReadonlyEditor() {
            const contentData = /*[[${ticket.content}]]*/ '';
            let editorData;
            
            try {
                editorData = contentData ? JSON.parse(contentData) : { blocks: [{ type: 'paragraph', data: { text: '暂无内容' } }] };
            } catch (e) {
                editorData = { blocks: [{ type: 'paragraph', data: { text: contentData || '暂无内容' } }] };
            }
            
            new EditorJS({
                holder: 'readonly-editor',
                readOnly: true,
                tools: {
                    header: Header,
                    list: List,
                    checklist: Checklist,
                    quote: Quote,
                    code: CodeTool,
                    delimiter: Delimiter,
                    image: ImageTool
                },
                data: editorData
            });
        }
        
        // 提交评论
        function submitComment() {
            const content = $('#comment-content').val().trim();
            if (!content) {
                AppUtils.showError('请输入评论内容');
                return;
            }
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/comments',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ content: content }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('评论发表成功');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '评论发表失败');
                    }
                },
                error: function() {
                    AppUtils.showError('评论发表失败');
                }
            });
        }
        
        // 指派工单
        function assignTicket() {
            const userId = $('#assign-user').val();
            if (!userId) {
                AppUtils.showError('请选择指派用户');
                return;
            }
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/assign',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ assigneeId: userId }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('工单指派成功');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '工单指派失败');
                    }
                },
                error: function() {
                    AppUtils.showError('工单指派失败');
                }
            });
        }
        
        // 改变工单状态
        function changeStatus(newStatus) {
            const reason = prompt('请输入状态变更原因（可选）：');
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/status',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ status: newStatus, reason: reason }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('状态更新成功');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '状态更新失败');
                    }
                },
                error: function() {
                    AppUtils.showError('状态更新失败');
                }
            });
        }
        
        // 显示移交模态框
        function showTransferModal() {
            $('#transfer-modal').removeClass('hidden');
        }
        
        // 隐藏移交模态框
        function hideTransferModal() {
            $('#transfer-modal').addClass('hidden');
            $('#transfer-user').val('');
            $('#transfer-reason').val('');
        }
        
        // 提交移交
        function submitTransfer() {
            const userId = $('#transfer-user').val();
            const reason = $('#transfer-reason').val().trim();
            
            if (!userId) {
                AppUtils.showError('请选择移交用户');
                return;
            }
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/transfer',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ toUserId: userId, reason: reason }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('工单移交成功');
                        hideTransferModal();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '工单移交失败');
                    }
                },
                error: function() {
                    AppUtils.showError('工单移交失败');
                }
            });
        }
    </script>
</th:block>
</html>
