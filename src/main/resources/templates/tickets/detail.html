<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE" th:text="'工单详情 - ' + ${ticket.ticketNo}">工单详情</title>
</head>

<th:block layout:fragment="custom-head">
    <!-- Editor.js CSS (只读模式) -->
    <style>
        .readonly-editor .codex-editor__redactor {
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
        }
        
        .readonly-editor .ce-block__content {
            max-width: none;
        }
        
        .readonly-editor .ce-toolbar {
            display: none !important;
        }
        
        .comment-content {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .flow-timeline {
            position: relative;
        }
        
        .flow-timeline::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
        }
        
        .flow-item {
            position: relative;
            padding-left: 40px;
            margin-bottom: 1rem;
        }
        
        .flow-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 8px;
            width: 16px;
            height: 16px;
            background-color: #3b82f6;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #e5e7eb;
        }
    </style>
</th:block>

<body>
    <div layout:fragment="content">
        <!-- 页面标题和操作栏 -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <div class="flex items-center space-x-3">
                    <h1 class="text-2xl font-bold text-gray-900" th:text="${ticket.title}">工单标题</h1>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full workspace-badge"
                          th:classappend="'status-' + ${#strings.toLowerCase(ticket.status)}"
                          th:text="${ticket.status.description}">状态</span>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full workspace-badge"
                          th:classappend="'priority-' + ${#strings.toLowerCase(ticket.priority)}"
                          th:text="${ticket.priority.description}">优先级</span>
                </div>
                <p class="text-gray-600 mt-1">
                    工单编号：<span class="font-mono" th:text="${ticket.ticketNo}">TICKET-001</span>
                    <span th:if="${ticket.workspace != null}">
                        | 工作空间：<span class="workspace-badge" th:style="'background-color: ' + ${ticket.workspace.color}" th:text="${ticket.workspace.name}">工作空间</span>
                    </span>
                </p>
            </div>
            <div class="flex space-x-3">
                <a th:href="@{/tickets/{id}/edit(id=${ticket.id})}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out">
                    <i class="fas fa-edit mr-2"></i>编辑
                </a>
                <a href="/tickets" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-150 ease-in-out">
                    <i class="fas fa-arrow-left mr-2"></i>返回列表
                </a>
            </div>
        </div>
        
        <!-- 主要内容区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：工单详情 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 工单描述 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">工单描述</h3>
                    </div>
                    <div class="p-6">
                        <div id="readonly-editor" class="readonly-editor"></div>
                    </div>
                </div>
                
                <!-- 评论区域 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">评论与讨论</h3>
                    </div>
                    <div class="p-6">
                        <!-- 添加评论 -->
                        <div class="mb-6">
                            <form id="comment-form">
                                <div class="mb-4">
                                    <label for="comment-content" class="block text-sm font-medium text-gray-700 mb-2">添加评论</label>
                                    <textarea id="comment-content" rows="3" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="请输入您的评论..."></textarea>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out">
                                        <i class="fas fa-comment mr-2"></i>发表评论
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- 评论列表 -->
                        <div class="space-y-4" th:if="${comments != null and !comments.isEmpty()}">
                            <div th:each="comment : ${comments}" class="border border-gray-200 rounded-lg p-4"
                                 th:classappend="${comment.type.name() == 'SYSTEM'} ? 'bg-blue-50 border-blue-200' : 'bg-white'">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium"
                                             th:classappend="${comment.type.name() == 'SYSTEM'} ? 'bg-blue-500' : 'bg-gray-500'"
                                             th:text="${comment.user?.realName?.substring(0,1) ?: 'S'}">U</div>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <span class="font-medium text-gray-900" th:text="${comment.user?.realName ?: '系统'}">用户名</span>
                                                <span class="text-xs text-gray-500" th:if="${comment.type.name() == 'SYSTEM'}">[系统消息]</span>
                                            </div>
                                            <span class="text-sm text-gray-500" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">时间</span>
                                        </div>
                                        <div class="mt-2 text-gray-700 comment-content" th:text="${comment.content}">评论内容</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 无评论提示 -->
                        <div class="text-center py-8 text-gray-500" th:if="${comments == null or comments.isEmpty()}">
                            <i class="fas fa-comments text-4xl mb-2"></i>
                            <p>暂无评论，成为第一个评论的人吧！</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：工单信息和操作 -->
            <div class="space-y-6">
                <!-- 工单信息 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">工单信息</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">类型</label>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full mt-1"
                                  th:classappend="'type-' + ${#strings.toLowerCase(ticket.type)}"
                                  th:text="${ticket.type.description}">类型</span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">创建人</label>
                            <div class="flex items-center mt-1" th:if="${ticket.creator != null}">
                                <div class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-medium mr-2"
                                     th:text="${ticket.creator.realName.substring(0,1)}">C</div>
                                <span th:text="${ticket.creator.realName}">创建人</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">指派人</label>
                            <div class="flex items-center mt-1" th:if="${ticket.assignee != null}">
                                <div class="w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-white text-xs font-medium mr-2"
                                     th:text="${ticket.assignee.realName.substring(0,1)}">A</div>
                                <span th:text="${ticket.assignee.realName}">指派人</span>
                            </div>
                            <span class="text-gray-500 text-sm mt-1" th:if="${ticket.assignee == null}">未指派</span>
                        </div>
                        
                        <div th:if="${ticket.resolver != null}">
                            <label class="block text-sm font-medium text-gray-700">解决人</label>
                            <div class="flex items-center mt-1">
                                <div class="w-6 h-6 rounded-full bg-purple-600 flex items-center justify-center text-white text-xs font-medium mr-2"
                                     th:text="${ticket.resolver.realName.substring(0,1)}">R</div>
                                <span th:text="${ticket.resolver.realName}">解决人</span>
                            </div>
                        </div>
                        
                        <div th:if="${ticket.estimatedHours != null}">
                            <label class="block text-sm font-medium text-gray-700">预估工时</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${ticket.estimatedHours} + ' 小时'">工时</span>
                        </div>
                        
                        <div th:if="${ticket.actualHours != null}">
                            <label class="block text-sm font-medium text-gray-700">实际工时</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${ticket.actualHours} + ' 小时'">工时</span>
                        </div>
                        
                        <div th:if="${ticket.dueDate != null}">
                            <label class="block text-sm font-medium text-gray-700">截止日期</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${#temporals.format(ticket.dueDate, 'yyyy-MM-dd HH:mm')}">截止时间</span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">创建时间</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${#temporals.format(ticket.createdAt, 'yyyy-MM-dd HH:mm')}">创建时间</span>
                        </div>
                        
                        <div th:if="${ticket.resolvedAt != null}">
                            <label class="block text-sm font-medium text-gray-700">解决时间</label>
                            <span class="text-sm text-gray-900 mt-1" th:text="${#temporals.format(ticket.resolvedAt, 'yyyy-MM-dd HH:mm')}">解决时间</span>
                        </div>
                    </div>
                </div>
                
                <!-- 快速操作 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">快速操作</h3>
                    </div>
                    <div class="p-6 space-y-3">
                        <!-- 指派工单 -->
                        <div>
                            <label for="assign-user" class="block text-sm font-medium text-gray-700 mb-2">指派给</label>
                            <div class="flex space-x-2">
                                <select id="assign-user" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">选择用户</option>
                                    <option th:each="user : ${users}" 
                                            th:value="${user.id}" 
                                            th:text="${user.realName}"
                                            th:selected="${ticket.assignee != null and user.id == ticket.assignee.id}">
                                        用户
                                    </option>
                                </select>
                                <button type="button" onclick="assignTicket()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700">
                                    指派
                                </button>
                            </div>
                        </div>
                        
                        <!-- 状态操作 -->
                        <div class="space-y-2">
                            <button type="button" onclick="changeStatus('IN_PROGRESS')" 
                                    class="w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'OPEN'}">
                                <i class="fas fa-play mr-2"></i>开始处理
                            </button>
                            
                            <button type="button" onclick="changeStatus('RESOLVED')" 
                                    class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'IN_PROGRESS'}">
                                <i class="fas fa-check mr-2"></i>标记解决
                            </button>
                            
                            <button type="button" onclick="changeStatus('CLOSED')" 
                                    class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'RESOLVED'}">
                                <i class="fas fa-archive mr-2"></i>关闭工单
                            </button>
                            
                            <button type="button" onclick="changeStatus('OPEN')" 
                                    class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out"
                                    th:if="${ticket.status.name() == 'CLOSED' or ticket.status.name() == 'RESOLVED'}">
                                <i class="fas fa-redo mr-2"></i>重新打开
                            </button>
                        </div>
                        
                        <!-- 移交工单 -->
                        <div>
                            <button type="button" onclick="showTransferModal()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-150 ease-in-out">
                                <i class="fas fa-exchange-alt mr-2"></i>移交工单
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 流转记录 -->
                <div class="bg-white shadow rounded-lg" th:if="${flows != null and !flows.isEmpty()}">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">流转记录</h3>
                    </div>
                    <div class="p-6">
                        <div class="flow-timeline">
                            <div th:each="flow : ${flows}" class="flow-item">
                                <div class="text-sm">
                                    <div class="font-medium text-gray-900" th:text="${flow.action}">操作</div>
                                    <div class="text-gray-600 mt-1">
                                        <span th:if="${flow.fromUser != null}" th:text="${flow.fromUser.realName}">操作人</span>
                                        <span th:if="${flow.toUser != null}"> → <span th:text="${flow.toUser.realName}">接收人</span></span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1" th:text="${#temporals.format(flow.createdAt, 'yyyy-MM-dd HH:mm')}">时间</div>
                                    <div class="text-sm text-gray-700 mt-1" th:if="${flow.reason != null and !flow.reason.isEmpty()}" th:text="${flow.reason}">原因</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 移交工单模态框 -->
        <div id="transfer-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">移交工单</h3>
                    <div class="mb-4">
                        <label for="transfer-user" class="block text-sm font-medium text-gray-700 mb-2">移交给</label>
                        <select id="transfer-user" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">选择用户</option>
                            <option th:each="user : ${users}" th:value="${user.id}" th:text="${user.realName}">用户</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="transfer-reason" class="block text-sm font-medium text-gray-700 mb-2">移交原因</label>
                        <textarea id="transfer-reason" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="请说明移交原因..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideTransferModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            取消
                        </button>
                        <button type="button" onclick="submitTransfer()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            确认移交
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<th:block layout:fragment="custom-script">
    <!-- Editor.js (只读模式) -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest/dist/editor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest/dist/bundle.js"></script>
    
    <script th:inline="javascript">
        let ticketId = /*[[${ticket.id}]]*/ null;
        
        $(document).ready(function() {
            // 初始化只读编辑器
            initReadonlyEditor();
            
            // 评论表单提交
            $('#comment-form').on('submit', function(e) {
                e.preventDefault();
                submitComment();
            });
        });
        
        // 初始化只读编辑器
        function initReadonlyEditor() {
            const contentData = /*[[${ticket.content}]]*/ '';
            let editorData;
            
            try {
                editorData = contentData ? JSON.parse(contentData) : { blocks: [{ type: 'paragraph', data: { text: '暂无内容' } }] };
            } catch (e) {
                editorData = { blocks: [{ type: 'paragraph', data: { text: contentData || '暂无内容' } }] };
            }
            
            new EditorJS({
                holder: 'readonly-editor',
                readOnly: true,
                tools: {
                    header: Header,
                    list: List,
                    checklist: Checklist,
                    quote: Quote,
                    code: CodeTool,
                    delimiter: Delimiter,
                    image: ImageTool
                },
                data: editorData
            });
        }
        
        // 提交评论
        function submitComment() {
            const content = $('#comment-content').val().trim();
            if (!content) {
                AppUtils.showError('请输入评论内容');
                return;
            }
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/comments',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ content: content }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('评论发表成功');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '评论发表失败');
                    }
                },
                error: function() {
                    AppUtils.showError('评论发表失败');
                }
            });
        }
        
        // 指派工单
        function assignTicket() {
            const userId = $('#assign-user').val();
            if (!userId) {
                AppUtils.showError('请选择指派用户');
                return;
            }
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/assign',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ assigneeId: userId }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('工单指派成功');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '工单指派失败');
                    }
                },
                error: function() {
                    AppUtils.showError('工单指派失败');
                }
            });
        }
        
        // 改变工单状态
        function changeStatus(newStatus) {
            const reason = prompt('请输入状态变更原因（可选）：');
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/status',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ status: newStatus, reason: reason }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('状态更新成功');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '状态更新失败');
                    }
                },
                error: function() {
                    AppUtils.showError('状态更新失败');
                }
            });
        }
        
        // 显示移交模态框
        function showTransferModal() {
            $('#transfer-modal').removeClass('hidden');
        }
        
        // 隐藏移交模态框
        function hideTransferModal() {
            $('#transfer-modal').addClass('hidden');
            $('#transfer-user').val('');
            $('#transfer-reason').val('');
        }
        
        // 提交移交
        function submitTransfer() {
            const userId = $('#transfer-user').val();
            const reason = $('#transfer-reason').val().trim();
            
            if (!userId) {
                AppUtils.showError('请选择移交用户');
                return;
            }
            
            $.ajax({
                url: '/api/tickets/' + ticketId + '/transfer',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ toUserId: userId, reason: reason }),

                success: function(response) {
                    if (response.success) {
                        AppUtils.showSuccess('工单移交成功');
                        hideTransferModal();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        AppUtils.showError(response.message || '工单移交失败');
                    }
                },
                error: function() {
                    AppUtils.showError('工单移交失败');
                }
            });
        }
    </script>
</th:block>
</html>
